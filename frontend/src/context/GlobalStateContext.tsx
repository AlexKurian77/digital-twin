"use client";

import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { API_BASE_URL } from '../config';

// Define the data types (lifted from LiveAQI)
export interface AQIData {
    aqi: number;
    aqi_category: string;
    pm2_5: number;
    pm10: number;
    o3: number;
    no2: number;
    so2: number;
    co: number;
    city?: string;
    source?: string;
}

export interface HealthImpactData {
    aqi_level: number;
    category: string;
    risk_summary: string;
    age_specific_impacts: {
        newborns: string;
        children: string;
        teenagers_young_adults: string;
        adults_36_65: string;
        elderly: string;
    };
    pregnancy_risks: string;
    pre_existing_conditions: {
        asthma: string;
        diabetes: string;
        cardiovascular: string;
    };
    immediate_actions: string[];
    long_term_risk: {
        life_expectancy_loss: string;
        chronic_conditions: string;
    };
    safeguard_protocols: string[];
    urgency_level: "Low" | "Medium" | "High" | "Critical";
}

interface GlobalStateContextType {
    aqiData: AQIData | null;
    isLoading: boolean;
    refreshAQI: () => Promise<void>;
    healthAnalysis: HealthImpactData | null;
    isAnalyzing: boolean;
    generateHealthAnalysis: () => Promise<void>;
}

const GlobalStateContext = createContext<GlobalStateContextType | undefined>(undefined);

export function GlobalProvider({ children }: { children: ReactNode }) {
    const [aqiData, setAqiData] = useState<AQIData | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [healthAnalysis, setHealthAnalysis] = useState<HealthImpactData | null>(null);
    const [isAnalyzing, setIsAnalyzing] = useState(false);

    const fetchAQI = async () => {
        setIsLoading(true);
        try {
            const response = await fetch(`${API_BASE_URL}/api/aqi?lat=28.7041&lon=77.1025`);
            if (!response.ok) {
                console.error(`API error: ${response.status}. Using mock data.`);
                const mockData = {
                    aqi: 50,
                    aqi_category: 'Good',
                    pm2_5: 12.5,
                    pm10: 25.0,
                    o3: 45.2,
                    no2: 28.5,
                    so2: 8.1,
                    co: 0.5
                };
                setAqiData(mockData);
                return;
            }
            const data = await response.json();
            setAqiData(data);
        } catch (error) {
            console.error('Failed to fetch AQI data:', error);
            const mockData = {
                aqi: 50,
                aqi_category: 'Good',
                pm2_5: 12.5,
                pm10: 25.0,
                o3: 45.2,
                no2: 28.5,
                so2: 8.1,
                co: 0.5
            };
            setAqiData(mockData);
        } finally {
            setIsLoading(false);
        }
    };

    const generateHealthAnalysis = async () => {
        if (!aqiData) return;
        setIsAnalyzing(true);
        try {
            const response = await fetch(`${API_BASE_URL}/api/analyze-aqi-health`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ aqi_data: aqiData }),
            });

            if (!response.ok) {
                throw new Error('Failed to fetch health analysis');
            }

            const data = await response.json();
            if (data.health_impact) {
                setHealthAnalysis(data.health_impact);
            }
        } catch (err) {
            console.error("Error fetching health impact:", err);
        } finally {
            setIsAnalyzing(false);
        }
    };

    useEffect(() => {
        fetchAQI();
        const interval = setInterval(fetchAQI, 600000); // 10 minutes
        return () => clearInterval(interval);
    }, []);

    return (
        <GlobalStateContext.Provider value={{
            aqiData,
            isLoading,
            refreshAQI: fetchAQI,
            healthAnalysis,
            isAnalyzing,
            generateHealthAnalysis
        }}>
            {children}
        </GlobalStateContext.Provider>
    );
}

export function useGlobalState() {
    const context = useContext(GlobalStateContext);
    if (context === undefined) {
        throw new Error('useGlobalState must be used within a GlobalProvider');
    }
    return context;
}
